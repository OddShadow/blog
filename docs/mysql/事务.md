---
title: 事务
author:
createTime: 2024/08/08 13:30:49
permalink: /article/wvbe8ab2/
---


## 1. 数据库事务概述
事务是数据库区别于文件系统的重要特性之一，当我们有了事务就会让数据库始终保持**一致性**，同时我们还能通过事务的机制**恢复到某个时间点**，这样可以保证已经已经提交到数据库的修改不会因为系统奔溃而丢失。
### 1.1 存储引擎支持情况
`SHOW ENGINES` 查看当前 MySQL 支持的存储引擎有哪些，以及这些存储引擎是否支持事务。
```mysql
mysql> show engines;
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |
| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |
| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |
| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |
| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |
| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |
| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |
| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |
| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
9 rows in set (0.00 sec)
```
**在 MySQL 中只有 InnoDB 支持事务**
### 1.2 基本概念
**事务**: 一组逻辑操作单元，使数据从一种状态变换到另一种状态
事务处理的原则：保证所有事务都作为一个工作单元来执行，即使出现了故障，都不能改变这种执行方式。当在一个事务中执行多个操作时，要么所有的事务都被提交( commit )，那么这些修改就永久地保存下来；要么数据库管理系统将放弃所作的所有修改，整个事务回滚( rollback )到最初状态。
### 1.3 事务特性 ACID
- **原子性** - atomicity
  事务中的操作像原子一样不可分割，要么全部提交，要么失败回滚。
- **一致性** - consistency
  事务执行前后，数据从一个合法性状态变成另一个合法性状态，和具体业务合法性关联。
  比如在A转B的一次转账中，A和B账户的余额大于零，A和B账户余额总和在转账前后不变。
- **隔离性** - isolation
  事务之间相互不干扰，不冲突。
- **持久性** - durability
  事务最终要落盘。
  持久性是通过重做日志和回滚日志保证的，即使数据库宕机重启也可以找回数据。
### 1.4 事务的状态
- 活动的 - active
- 部分提交的 - partially committed
- 失败的 - failed
- 中止的 - aborted
- 提交的 - committed
  ![[20240627142859465.png|500]]
## 2. 如何使用事务
### 2.1 显式事务
`start transaction;` 或者 `begin;`
两者都可以开启事务，区别在于 `start transaction;` 可以接几个修饰符
1. read only，只读事务
2. read write，读写事务
3. with consistent snapshot，启动一致性读
### 2.2 隐式事务
`show variables like 'autocommit';`
开启表示，开启了自动提交
## 3. 事务的隔离级别
MySQL是一个客户端／服务器架构的软件，对于同一个服务器来说，可以有若干个客户端与之连接，每个客户端与服务器连接上之后，就可以称为一个会话（Session ）。每个客户端都可以在自己的会话中向服务器发出请求语句，一个请求语句可能是某个事务的一部分，也就是对于服务器来说可能同时处理多个事务。事务有隔离性的特性，理论上在某个事务对某个数据进行访问时，其他事务应该进行排队，当该事务提交之后，其他事务才可以继续访问这个数据。但是这样对性能影响太大，我们既想保持事务的隔离性，又想让服务器在处理访问同一数据的多个事务时性能尽量高些，那就看二者如何权衡取舍了。
### 3.1 数据准备
### 3.2 数据并发问题
1. 脏写
2. 脏读
3. 不可重复读
4. 幻读
### 3.3 SQL 中四种隔离级别
1. 读未提交 read uncommitted
2. 读已提交 read commited
3. 可重复度 repeatable read
4. 串行化 serializable

|隔离级别|脏读可能性|不可重复读可能性|幻读可能性|加锁读|
|-|-|-|-|-|
|读未提交|yes|yes|yes|no|
|读已提交|no|yes|yes|no|
|可重复度|no|no|yes|no|
|串行化|no|no|no|yes|

### 3.4 MySQL 支持的四种隔离级别
查看隔离级别 `SELECT @@transaction_isolation;`
### 3.5 如何设置事务的隔离级别
`SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL 隔离级别;`
`SET [GLOBAL|SESSION] TRANSACTION_ISOLATION = '隔离级别';`
1. READ UNCOMMITTED
2. READ COMMITTED
3. REPEATABLE READ
4. SERIALIZABLE
### 3.6 不同隔离级别举例
## 4. 事务的常见分类
